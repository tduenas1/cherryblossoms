---
title: "Data Visualization"
output: rmdformats::material
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 3DS : Cherry Blossom

## Lyuda Bekwinknoll, Meghana Cyanam, Theresa Marie Duenas, Kevin Kiser

With our data visualization we are determining the association between age and fitness based on running data from the Cherry Blossom Ten-mile Run held in Washington DC from 1973 to 2020.

# Loading and Cleaning Data

```{r, message = F}
# load packages
library(dplyr)
library(ggplot2)
library(chron)
library(plotly)
library(purrr)
library(RColorBrewer)
library(readr)
```

```{r, warning = FALSE}

cb_10M_1973_2005_weather <- read_csv("cb_10M_1973_2005_weather.csv", show_col_types = FALSE)

cb_10M_2006_2019_weather <- read_csv("cb_10M_2006_2019_weather.csv", show_col_types = FALSE)

clean_data <- function(df) {
  df <- dplyr::select(df, Year, Name, Age, 
               Time, Division, pos_by_sex, 
               total_by_sex, Sex, PRCP, TMAX, TMIN)

  df$Age[df$Age == 'NR'] <- 0
  df$Time[df$Time == 'NR'] <- 0

df <- df %>%
    mutate(
      Year = as.integer(Year),
      Name = as.character(Name),
      Age = as.integer(Age, na.rm = TRUE),
      Time = as.character(Time),
      Division = as.character(Division),
      pos_by_sex = as.integer(pos_by_sex),
      total_by_sex = as.integer(total_by_sex),
      Sex = as.character(Sex),
      PRCP = as.numeric(PRCP),
      TMAX = as.integer(TMAX),
      TMIN = as.integer(TMIN)
    )
  
  return(df)
}

df1 <- clean_data(cb_10M_1973_2005_weather)
df2 <- clean_data(cb_10M_2006_2019_weather)


df <- bind_rows(df1, df2)
```

```{r, warning = FALSE}

# fixes times with mins recorded as hrs (mm:ss:00 -> 00:mm:ss)
df <- df %>%
  mutate(
    Time = ifelse(
      Time >= "43:00:00" & Time <= "59:59:59",
      paste0("00:", substr(Time, 1, 2), ":", substr(Time, 4, 5)),
      Time
    )
  )


df <- df %>%
  filter(!is.na(Time) & Time != "" & Time != "00:00:00") %>%
  mutate(Time = chron::times(Time)) %>%
  filter(!is.na(Time)) %>%
  filter(Time >= "00:43:00" & Time <= "02:20:00") %>%
  filter(Age >= 8 & Age <= 87) %>%
  mutate(
    # replaces 'W' with 'F' in sex col
    Sex = ifelse(Sex == 'W', 'F', Sex),
    # correction for missing values by first character in division
    Sex = ifelse(substr(Division, 1, 1) == 'W', 'F', Sex),
    Sex = ifelse(substr(Division, 1, 1) == 'M', 'M', Sex)
  )

```

```{r}
# add final data to git repository
# write.csv(df, "cleaned_10M_1973_2019.csv", row.names = FALSE)

```

# Describing our Data

| Variable Names | Data Type    | Variable Descriptions                      |
|----------------|--------------|--------------------------------------------|
| Year           | Integer      | Year the race was held.                    |
| Name           | Character    | First and last name of runner.             |
| Age            | Integer      | Age of runner at time of race. He          |
| Time           | Time/Numeric | Time in hr:min:sec format to run 10 miles. |
| Division       | Character    |                                            |
| pos_by_sex     | Integer      |                                            |
| total_by_sex   | Integer      |                                            |
| Sex            | Character    | Gender of runner.                          |
| PRCP           | Numeric      |                                            |
| TMAX           | Integer      | Temperature maximum for the race day       |
| TMIN           | Integer      | Temperature minimum for the race day       |

## Dataset Overview:

In the original data set we have 347402 rows and 17 columns. After cleaning the data set we ended up with 339934 rows and 11 columns. 7468 rows of data were omitted from the data we used because they had missing values for the time and/or age variables. Below is the description of the variables and data we excluded for our data analysis/visualization:

| What was excluded | Reason for exclusion |
|-------------------|----------------------|
| Hometown          |                      |
| Distance          |                      |
| Date              |                      |
| pos_by_div        |                      |
| total_by_division |                      |
| Pace              |                      |
| Year 1977?        |                      |

## Summary Statistics:

Year, Age, Time, Sex main variables to focus on.

Checklist for this section:

summary stats: mean, median, mode, range, sd, percentiles, distributions by sex variable, etc.

mention how many women and how many men in each year and overall

```{r}

```

These were helping me evaluate the data cleaning, we can fix or replace them later

```{r}
# Function to create histogram and density plot pairs for different years
plot_histogram_density <- function(plot_year, cleaned_data) {
  # Pulls out data from 'cleaned_data' based on 'plot_year'
  subset_data <- df[df$Year == plot_year, ]
  
  # Makes histogram of data without plotting it
  hist_data <- hist(subset_data$Time, breaks = 10, plot = FALSE)
  
  # Plots above generated histogram with color and labels
  plot(hist_data, col = "lightblue",
       main = paste("", plot_year),
       xlab = "Time (hr:min)",
       ylab = "Density",
       freq = FALSE, xaxt = "n")
  
  # Custom x-axis with labels as hours and minutes
  axis(1, at = hist_data$breaks,
       labels = chron(times = hist_data$breaks, format = "h:mm"),
       las = 2)
  
  # Adds density plot line in blue over histogram
  lines(density(subset_data$Time), col = "blue", lwd = 2)
}

# Function to create a matrix layout for plots
plot_histogram_matrix <- function(years, df, parx, pary) {
  # Set the layout for plots
  par(mfrow = c(parx, pary))
  
  # Loop over the specified years and call the plot function
  for (year in years) {
    plot_histogram_density(year, df)
  }
}

# Call the function with the range of years and custom layout parameters
plot_histogram_matrix(1973:1982, df, 2, 5)
plot_histogram_matrix(1983:1992, df, 2, 5)
plot_histogram_matrix(1993:2002, df, 2, 5)
plot_histogram_matrix(2003:2012, df, 2, 5)
plot_histogram_matrix(2013:2017, df, 1, 5)
plot_histogram_matrix(2018:2019, df, 1, 2)

```
