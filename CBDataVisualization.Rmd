---
title: "Data Visualization"
author: "Lyuda Bekwinknoll, Meghana Cyanam, Theresa Marie Duenas, Kevin Kiser"
output:
pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 3DS : Cherry Blossom 10-Mile Race

### Lyuda Bekwinknoll, Meghana Cyanam, Theresa Marie Duenas, Kevin Kiser

With our data visualization we are determining the association between age and fitness based on running data from the Cherry Blossom Ten-Mile Race held in Washington DC from 1973 to 2019.

**Background:**

The Credit Union Cherry Blossom (CUCB) is a non-profit organization that runs an annual 10-mile race in Washington, D.C. This race occurs the first Sunday of each April and contestants are admitted to run the race based on a lottery entry system. The lottery entry started in 1980 with 1977 being the first year that had to limit voluntary runners. Using the data collected from this race, we are exploring the relationship between aging and fitness.

**Data Extraction Method:**

We created a Jupyter notebook to conduct the data scraping from the webpage: \<<https://www.cballtimeresults.org/performance-search/?eventType=10M&year=1973&division=M&page=1>\>. The Python library "requests" was used to connect to the URL, and "BeatifulSoup" was used to parse through the HTML and extract the data. We wrote a function that iterated through the specified variables (section, division, year, and page) to ensure all the data was collected. The CUCB website contains data for the following columns: Name, PiD/TiD, PiS/TiS, Age, Time, Pace, Division, and Home Town. The data was scraped for men and women between 1973 and 2019. 1973 was the first year the event was held, and 2019 was the year before organizers canceled the event for the first time due to COVID-19.

We incorporated weather data from the National Oceanic and Atmospheric Administration (NOAA) and the National Centers for Environmental Information. The closest option to the marathon was the Washington Reagon Airport, Arlington, VA, situated on the banks of the Potomac across from the National Mall, where most of the marathon takes place. From that data set, we added precipitation and minimum and maximum temperatures for each day the race took place. Each event date was manually recorded from the Rite of Spring pdf that detailed the history of the marathon and used to join only the relevant data for each event date.

# Describing our Data

## Dataset Overview:

In the original data set we have 347402 rows and 17 columns. After cleaning the data set we ended up with 339934 rows and 17 columns. 7468 rows of data were omitted from the data we used because they had missing values for the time and/or age variables.

+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Variable Names    | Data Types   | Variable Descriptions                                                                                                                                                                  | How does this variable contribute to project objectives?                                                                                                                                                                                                        |
+===================+==============+========================================================================================================================================================================================+=================================================================================================================================================================================================================================================================+
| Year              | Integer      | Year the race was held.                                                                                                                                                                | Data is spanned over several years giving us the ability to see how people who ran the race for multiple years changed in times. Also this contains data from a lot of years, giving us access to more data.                                                    |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Date              | Character    | Date on which the race was held in year-month-day format.                                                                                                                              | Excluded. Look below for more information on why.                                                                                                                                                                                                               |
|                   |              |                                                                                                                                                                                        |                                                                                                                                                                                                                                                                 |
|                   |              | example: 1973-04-01                                                                                                                                                                    |                                                                                                                                                                                                                                                                 |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Distance          | Character    | An alphanumeric character telling us that the race ran was "10M" 10 miles.                                                                                                             | Excluded. Look below for more information on why.                                                                                                                                                                                                               |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Name              | Character    | An individual's first and last name with varying formats. Most of the CUCB website results for names also list an 'M', 'F', or 'W' in parenthesis for the individual's sex.            | Used as a personal identifier source for each runner. We plan to use this variable in the future to find runners that ran several times and see how their run times changed. This will be done in our final project not necessarily in this data visualization. |
|                   |              |                                                                                                                                                                                        |                                                                                                                                                                                                                                                                 |
|                   |              | example: James Yenckel (M)                                                                                                                                                             |                                                                                                                                                                                                                                                                 |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Age               | Integer      | Age of runner at time of race.                                                                                                                                                         | One of our main variables. Gives us runner ages so we can see how performance differs across age ranges and whether younger people have better times.                                                                                                           |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Time              | Time/Numeric | Time in hr:min:sec format to run 10 miles. This is how long it took each runner to complete the race.                                                                                  | One of our main variables. Gives us the runner times so we can see how the times spread as age changes.                                                                                                                                                         |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Division          | Character    | 28 different divisions are contained, 14 in each sex. They range from 4 of\                                                                                                            | This variable is used to break data into age groups which we then use to draw conclusions about our question.                                                                                                                                                   |
|                   |              | them having 20 year ranges, while the rest have 5 year ranges. Each division is an alphanumeric code separating competitors by sex and age. The example shows 25 to 29-year-old women. |                                                                                                                                                                                                                                                                 |
|                   |              |                                                                                                                                                                                        |                                                                                                                                                                                                                                                                 |
|                   |              | example: W2529                                                                                                                                                                         |                                                                                                                                                                                                                                                                 |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| pos_by_division   | Integer      | This variable gives us the position that a runner finished in their assigned division for a certain year.                                                                              | Excluded. Look below for more information on why.                                                                                                                                                                                                               |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| total_by_division | Integer      | This variable gives the total number of individuals in each division for a certain year.                                                                                               | Excluded. Look below for more information on why.                                                                                                                                                                                                               |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| pos_by_sex        | Integer      | Shows the place that a runner finished by sex per year.                                                                                                                                | Excluded. Look below for more information on why                                                                                                                                                                                                                |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| total_by_sex      | Integer      | The total number of competitors overall for a sex per year.                                                                                                                            | Excluded. Look below for more information on why.                                                                                                                                                                                                               |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Sex               | Character    | Gender of runner.                                                                                                                                                                      | This is an important variable since it allows us to compare the two sexes and their times as compared to viewing them together.                                                                                                                                 |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Hometown          | Character    | Hometown of runner.                                                                                                                                                                    | Excluded. Look below for more information on why.                                                                                                                                                                                                               |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| PRCP              | Numeric      | Precipitation recorded as daily rainfall in inches to one decimal place collected by NOAA.                                                                                             | This variable does not contribute directly to our project objectives but it used to provide information about whether it rained the day of the race or not, and how much it rained.                                                                             |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| TMIN              | Integer      | Minimum daily temperature recorded in Fahrenheit, collected by NOAA.                                                                                                                   | This variable does not contribute directly to our project objectives but it's used to provide information about the temperature minimum of the day of the race.                                                                                                 |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| TMAX              | Integer      | Maximum daily temperature recorded in Fahrenheit, collected by NOAA                                                                                                                    | This variable does not contribute directly to our project objectives but it's used to provide information about the temperature maximum of the day of the race.                                                                                                 |
+-------------------+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

Below is the description of the variables and data we excluded/not used in our analysis or modified for our data analysis/visualization:

+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **What was excluded/modified**                | **Reason for exclusion/modification**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Hometown                                      | Many missing values and inconsistencies were found in the data entries. We found a few individuals reporting their hometown differently each time they ran the race or just reporting several at once. Due to this we decided to remove this variable from our analysis because there are no accurate conclusions that can be drawn. Also this is not a variable we could use to fulfill our main objective, so we chose to exclude it from our analysis.                                                                                                                                                                                                                                                                                                                                                                  |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Distance                                      | The data in this column was describing the race of this length which is 10 miles. Since we already know it is the data from the 10 mile race, having a column that explicitly states that for row of our data is redundant.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Date                                          | We decided to exclude this variable since we know that the race happens at a certain time each year during spring, and having the specific dates would not impact our data question in any way.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| pos_by_sex                                    | This variable gave us the position that a runner finished based on sex of each year. We decided to not use this variable in our data visualization since it was not important to meet our goal.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| total_by_sex                                  | This variable gave us the total number of people by sex per year. We decided to not include it in our analysis since it was not important for visualizing our main goal in exploring this data.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| pos_by_div                                    | This variable gives us the position that a runner finished in their assigned division for a certain year. We decided to to not use this variable in our data visualization since it wasn't important to drawing conclusion for our main goal.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| total_by_division                             | This variable gives the total number of individuals in each division for a certain year. The divisions are the same as described above and are excluded for the same reason as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Pace                                          | The Pace gave the pace per mile of each runner for the race. We decided to exclude this from our analysis because of the fact it wasn't reading in correctly. Also the pace can be calculated directly from the Time variable by dividing it by 10 (the total miles in the race). Therefore we decided to remove this column of data from our data frame.                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Data from the year of 1973                    | After we cleaned the data, we only had 2 entries left that could be analyzed for that year. Because there were only 2 entries for that year, we decided to exclude it from our analysis because it allegedly does nothing in the context of our goal and it would be kind of useless to graph only 2 points.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Data from the year of 1977                    | We decided to remove the data from the year of 1977 due to the fact that there was a large chunk of data missing from the times right in the middle of the race time. We are not given information about what happened in that period that resulted in such record, so we don't have any background about that. Also if we keep this year in our data analysis, is has a potential to make our data analysis biased since there are a lot of points missing from a main part of the times, which would lead to inaccuracy in our interpretations. That is why we have decided to exclude the year from our data.                                                                                                                                                                                                           |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Data from the year of 2015 (not yet modified) | The distance of the race ran in 2015 was only 9.39 miles long. Because the data was still good as a whole, we decided to modify the race times using the overall time so the data would be as that of a 10 mile race. We did not have the time to do it for this data visualization project, but plan on doing it with our final.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|                                               | We plan on making this modification by finding the pace of each runner in 2015, dividing that by 9.39 to obtain their pace per mile, and multiplying it by 10 to get their time if they kept that pace for 10 miles.. The times included here will not the actual times of the runners since they have been modified, but the times are "standardized" to be that of a 10 mile race to remove the bias of the race being shorter for this year. If this race would have been the full 10 miles, the times would have been slightly different, but that difference would have been very minimal and insignificant from our modified data of this year for this analysis. Therefore, we decided that this would be a good way to approach the times for this years race instead of just removing all of the data as a whole. |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Data from the year of 2019 (not yet modified) | The distance of the race ran in 2019 was 80 yards shy of 10 miles. Due to this we decided to "standardize" the times for the same reasons as above. We haven't done it yet for this data visualization project since we ran out of time, but we plan on doing so for our final.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|                                               | We plan on doing this modification by finding the average pace for each runner in that year and multiplying that by 10 for each runner, giving us the race times for the runner for 10 miles. The same limitations and things should be taken into account for this new time as above. Our group decided it was best to modify this data then to remove it.                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
+-----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

# Challenges that occured
## Problem with Data and biases/problem with application
  While looking at the data we started to run into some problems. Looking at the history of the races and what went on during it could explain some of the data. A lot of these were covered in the data cleaning (as seen above). Some of the things that we encountered as well were weather patterns that caused changes to the data, the years that this happened were in 1982, 1984, 1987, 1988, 1992, 1996, 2000, 2004, and 2016. In 1982 winds were going 50 mph while 1988 had winds going 25 mph, 1992 had 30-35 mph winds, 2004 had 40 mph winds and 2016 had winds going at 47 mph, these winds slowed runners as they fought against the wind. Also in 1987, there was “favorable wind”. In 1984 there were flooding with 6 inches of flooding at one part of the race and similarly, in 1996 there were 100-yard puddles. Lastly with weather issues in 2000 there was snow before the race and it got extremely chilly and were slowed to almost a walk on the Memorial Bridge. We started to take these by importing weather data from the National Oceanic and Atmospheric Administration (NOAA) and the National Centers for Environmental Information.
  Another outside issue that arose while looking at the history was the many times the route of the race was changed, as the courses changed throughout the years it could have changed the times that it took to complete the race. The first time the race changed was in 1993 and then again in 1999 which included many curves which slowed the times, then it changed again in 2003 due to the war in Iraq. In 2008 the course was changed and updated, and then in 2009 they used the same route but ran it in reverse. It was changed and rerouted once more in 2017. 
  Another fact we found out that could’ve skewed the data was that in 2006 women started to start 10 minutes ahead of the men. This changes the data but to solve this issue we plan to separate the two sexes and look at the linear line separately to find if there is still a pattern between age and performance.
  Lastly, as the times were analyzed it looked as if as the years went by there was a significant change in the finishing times in the top few. It was found out that The race first began as a small gathering of runners and originally as a precursor training run for elite runners planning to compete in the Boston Marathon. It has evolved over the years into a local race for runners of all abilities which skews the data as it becomes more prestigious and competitive. 
Other than the outside forces that were found out from the race's history there was an issue with the formatting of a few graphs. While making the graphs they had automatic formatting at times that was inconsistent and hard to interpret. To fix this issue custom ticks were created to keep consistency. The times that were marked were 00:42, 01:13, 01:45, 02:17, and 02:49. 


# Loading and Cleaning Data

```{r, message = F, echo=FALSE}
# load packages
library(tinytex)
library(dplyr)
library(ggplot2)
library(chron)
library(plotly)
library(purrr)
library(RColorBrewer)
library(readr)
library(ggridges)
library(hms)
library(summarytools)
library(GGally)
library(olsrr)
library(leaps)
```

```{r, warning = FALSE, echo=FALSE}

cb_10M_1973_2005_weather <- read_csv("cb_10M_1973_2005_weather.csv", show_col_types = FALSE)

cb_10M_2006_2019_weather <- read_csv("cb_10M_2006_2019_weather.csv", show_col_types = FALSE)

clean_data <- function(df) {
  df <- dplyr::select(df, Year, Name, Age, 
               Time, Division, pos_by_sex, 
               total_by_sex, Sex, PRCP, TMAX, TMIN)

  df$Age[df$Age == 'NR'] <- 0
  df$Time[df$Time == 'NR'] <- 0

df <- df %>%
    mutate(
      Year = as.integer(Year),
      Name = as.character(Name),
      Age = as.integer(Age, na.rm = TRUE),
      Time = as.character(Time),
      Division = as.character(Division),
      pos_by_sex = as.integer(pos_by_sex),
      total_by_sex = as.integer(total_by_sex),
      Sex = as.character(Sex),
      PRCP = as.numeric(PRCP),
      TMAX = as.integer(TMAX),
      TMIN = as.integer(TMIN)
    )
  
  return(df)
}

df1 <- clean_data(cb_10M_1973_2005_weather)
df2 <- clean_data(cb_10M_2006_2019_weather)


df <- bind_rows(df1, df2)
```

```{r, warning = FALSE, echo=FALSE}

# fixes times with mins recorded as hrs (mm:ss:00 -> 00:mm:ss)
df <- df %>%
  mutate(
    Time = ifelse(
      Time >= "43:00:00" & Time <= "59:59:59",
      paste0("00:", substr(Time, 1, 2), ":", substr(Time, 4, 5)),
      Time
    )
  )


df <- df %>%
  filter(!is.na(Time) & Time != "" & Time != "00:00:00") %>%
  mutate(Time = chron::times(Time)) %>%
  filter(!is.na(Time)) %>%
  filter(Time >= "00:43:00" & Time <= "02:20:00") %>%
  filter(Age >= 8 & Age <= 87) %>%
  filter(Year != 1977) %>%
  filter(Year != 1973) %>%
  mutate(
    # replaces 'W' with 'F' in sex col
    Sex = ifelse(Sex == 'W', 'F', Sex),
    # correction for missing values by first character in division
    Sex = ifelse(substr(Division, 1, 1) == 'W', 'F', Sex),
    Sex = ifelse(substr(Division, 1, 1) == 'M', 'M', Sex)
  )

```

```{r, echo=FALSE}
# add final data to git repository
 write.csv(df, "cleaned_10M_1973_2019.csv", row.names = FALSE)

```

## Summary Statistics:

Year, Age, Time, Sex main variables to focus on.

Checklist for this section:

summary stats: mean, median, mode, range, sd, percentiles, distributions by sex variable, etc.

mention how many women and how many men in each year and overall

```{r descriptive_stats, results="asis", warning=FALSE, echo=FALSE}
df  %>% select(Year, Age, Time, Sex, PRCP, TMAX, TMIN) %>% 
dfSummary(
          varnumbers = FALSE,
          plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE,
          tmp.img.dir  = "/tmp")

df  %>% select(Year, Age, Time, Sex, PRCP, TMAX, TMIN) %>% group_by(Sex) %>%
dfSummary(
          varnumbers = FALSE,
          plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75,  
          valid.col    = FALSE,
          tmp.img.dir  = "/tmp")

```

```{r, echo=FALSE}
x <- df$Age
fit <- density(x)

plot_ly(x = x, type = "histogram", name = "Histogram") %>%
  add_trace(
    x = fit$x, y = fit$y,
    type = "scatter", mode = "lines",
    fill = "tozeroy", yaxis = "y2", name = "Density Curve",
    line = list(color = "red"),  # Change the density curve line color here
    fillcolor = 'rgba(0, 0, 255, 0.4)'  # Change the histogram bars fill color here
  ) %>%
  layout(
    title = "Distribution and Density Curve \n All Years",
    xaxis = list(
      title = "Age (Years)",
      showline = TRUE
    ),
    yaxis2 = list(
      title = "Density",
      showline = TRUE,
      overlaying = "y"
    ),
    yaxis = list(
      showticklabels = FALSE,
      side = "left"
    )
  ) %>%
  config(scrollZoom = FALSE, displayModeBar = FALSE, editable = FALSE)
# config settings turn of interactive features of plotly for
```

```{r, echo=FALSE}
x <- df$Time
fit <- density(x)

custom_ticks <- c("00:42", "01:13", "01:45", "02:17", "02:49")
tick_positions <- seq(min(x), max(x), length.out = length(custom_ticks))
tick_labels <- as.numeric(tick_positions)

plot_ly(x = x, type = "histogram", name = "Histogram") %>%
  add_trace(
    x = fit$x, y = fit$y,
    type = "scatter", mode = "lines",
    fill = "tozeroy", yaxis = "y2", name = "Density Curve",
    line = list(color = "red"),  # Change the density curve line color here
    fillcolor = 'rgba(0, 0, 255, 0.4)'  # Change the histogram bars fill color here
  ) %>%
  layout(
    title = "Distribution and Density Curve \n All Years",
    xaxis = list(
      title = "Time (hr:min)",
      showline = TRUE,
      tickvals = tick_positions,
      ticktext = custom_ticks
    ),
    yaxis2 = list(
      title = "Density",
      showline = TRUE,
      overlaying = "y"
    ),
    yaxis = list(
      showticklabels = FALSE,
      side = "left"
    )
  ) %>%
  config(scrollZoom = FALSE, displayModeBar = FALSE, editable = FALSE)
# config settings turn of interactive features of plotly for
```

```{r ridge line density plot, echo=FALSE, warning=FALSE }
  
plot_age_dist <- ggplot(df, aes(x = Age, y = as.factor(Year))) +
    geom_density_ridges_gradient(
      aes(fill = ..x..), scale = 3, size = 0.3
    ) +
    scale_fill_gradientn(
      colours = c("#0D0887FF", "#CC4678FF", "#F0F921FF"),
      name = "Age"
    ) +
    labs(title = 'Age Distribution by Year', y="")
  
plot_age_dist

custom_ticks <- c("00:43", "01:07", "01:30", "01:56", "02:20")
tick_positions <- seq(min(df$Time), max(df$Time), length.out = length(custom_ticks))
tick_labels <- times(tick_positions)

  # Plotting density ridgeline plot for Time by Year
 plot_time_dist <-  ggplot(df, aes(x = Time, y = as.factor(Year))) +
    geom_density_ridges_gradient(
      aes(fill = ..x..), scale = 3, size = 0.3
    ) +
    scale_fill_gradientn(
      colours = c("red", "purple", "blue"),
      name = "Time to finish",
      breaks = tick_positions,
      labels = custom_ticks
    ) +
   scale_x_continuous(labels = tick_labels, breaks = tick_positions
    ) +
    labs(title = 'Time Distribution by Year', y = "")

 plot_time_dist
```

```{r}
# Probalby not using this but saving the code in case we need a single scatter plot

# Creating a scatterplot function that inputs the current year and data and
# outputs scatterplot for the year and its trend line

#scat_plot <- function(curr_year, df) {
  # Subsetting data by given year
#  sub_data <- df %>% filter(Year == curr_year)
  
  # Scatterplot using ggplot2
#  ggplot(sub_data, aes(x = Age, y = as.numeric(Time))) +
#    geom_point(col = "blue", shape = 1) +
#    geom_smooth(method = "lm", se = FALSE, col = "red") +
#    labs(title = as.character(curr_year), x = "Age (years)", y = "Time (hh:mm)") +
#    scale_y_continuous(labels = custom_ticks, breaks = tick_positions)
#}

# Setting up the layout
#par(mfrow = c(2, 4))

# Loops over years 1973:2019 and calls the scat_plot function
# unique(Year) skips 1977 and will work still work if we remove other years
#for (curr_year in unique(df$Year)) {
#  print(scat_plot(curr_year, df))
#}

```

```{r scatterplot by year, echo=FALSE, warning=FALSE, fig.dim = c(8, 16)}

#splitting time to seconds
 time_components <- strsplit(as.character(df$Time), ":")
 df$Time_in_seconds <- sapply(time_components, function(x) {
   as.numeric(x[1]) * 3600 + as.numeric(x[2]) * 60 + as.numeric(x[3])
 })

# Convert 'Time_in_seconds' back to "hh:mm" format for y-axis labels
df$Time_hh_mm <- sprintf("%02d:%02d", df$Time_in_seconds %/% 3600, (df$Time_in_seconds %% 3600) %/% 60)

#scatterplot of Age vs Time all data 
ggplot(df,aes(x=Age, y=Time_in_seconds))+
  geom_point(alpha= 0.1, color="purple", size = .5)+
  labs(title = "Age vs Time scatterplots", y="Time (hr:min:sec)")+
  geom_smooth(formula = y ~ x, method = lm, se = FALSE)+
  scale_y_continuous(labels = function(x) as.character(hms(seconds = x), format = "%H:%M")) +
  theme_bw()+
  facet_wrap(~as.factor(Year),ncol = 5)
```

### Model Fitting

We would like to fit a model to see if there is a relationship between age, gender and weather conditions on the performance of runners in the CUCB run. We found that the best indicator for the performance in the race is gender followed by age and weather conditions.

$$ Performance(Time) = \beta_0 + \beta_1 Sex + \beta_2 Age + \beta_3 Pecipitation + \beta_4 Man Temps + \beta_5 Min Temps
$$

The coefficient of determination $R^2 = 20.25\%$. $R^2$ tells us how much variability the above variables contribute to the performance. So from $R^2$ we can say that there we are missing around $80\%$ of the contributions to the performance that may or may not be recorded in the race data.

```{r time to seconds, eval=FALSE, warning=FALSE, include=FALSE}

#splitting time to seconds
 time_components <- strsplit(as.character(df$Time), ":")
 df$Time_in_seconds <- sapply(time_components, function(x) {
   as.numeric(x[1]) * 3600 + as.numeric(x[2]) * 60 + as.numeric(x[3])
 })

# Convert 'Time_in_seconds' back to "hh:mm" format for y-axis labels
df$Time_hh_mm <- sprintf("%02d:%02d", df$Time_in_seconds %/% 3600, (df$Time_in_seconds %% 3600) %/% 60)
```

```{r eval=FALSE, include=FALSE}
ggplot(df, aes(x=(pos_by_sex/total_by_sex), y = Time_in_seconds))+
  geom_point(alpha = 0.2, color = "violet", size=0.5)
```

```{r finding the best subset, include=FALSE}
best_subset <- regsubsets(Time_in_seconds ~ Age + Sex 
                          + PRCP + TMAX + TMIN , data = df)
summary(best_subset)

```

```{r include=FALSE}
model <- lm(Time_in_seconds ~  Sex+ Age + PRCP + TMAX + TMIN , data = df)
summary(model)


```

The fitted model takes the form:

$$ Performance(Time) = 5044.28 -834.94 Sex + 16.81 Age -559.14 Pecipitation + 9.82 Man Temps -7.92 Min Temps
$$

We can see from the model that being being Female negatively effects the performance but so does weather factors like rain and minimum temperatures.

#### Assumptions

To fit a linear model we first need to make a few assumptions

-   The relationship between $Y$ and $\beta$'s is linear.

-   The errors are normally distributed. We can check this by plotting a normal Quantile-Quantile Plot

```{r qqplot, echo=FALSE}
ols_plot_resid_qq(model, print_plot = TRUE)
```

-   The errors are uncorrelated. But we see that it is not the case from the plot below.

-   The errors have constant variance and zero mean.

```{r res vs fit, echo=FALSE, warning=FALSE}
#ols_plot_resid_fit(model, print_plot = TRUE)

ggplot(model, aes(x= .fitted, y= .resid))+
  geom_point(alpha = 0.1, color="violet", size = 0.5)+
  geom_hline(yintercept = 0, color = "red")+
  labs(title = "Residual Error vs Fitted Values",
       y = "Residual Errors(seconds)", x="Fitted Values(seconds)")+
  theme_bw()
```
